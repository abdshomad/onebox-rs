```mermaid
graph TD
    A[Start onebox-server] --> B{Parse CLI & Load Config};
    B --> C[Create TUN Device, <br> Setup IP Forwarding & NAT];
    C --> D[Bind Public UDP Socket];
    D --> E((Spawn Main Tasks));

    subgraph "Main Server Loop"
        direction LR
        E -- "Dispatcher" --> F(Task 1: Dispatcher);
        E -- "Workers" --> G(Task 2: Worker Pool);
        E -- "Downstream" --> H(Task 3: TUN to UDP);
    end

    F --> F_1[Listens on Public UDP Socket];
    F_1 --> F_2[Receives all incoming packets];
    F_2 --> F_3[Forwards packet to <br> Worker Pool via channel];
    F_3 --> F_1

    G -- "Receives packet from channel" --> G_1{Deserialize Header & Decrypt};
    G_1 --> G_2{Switch on Packet Type};
    G_2 -- "AuthRequest" --> G_3[Authenticate Client <br> Send AuthResponse];
    G_2 -- "Probe" --> G_4[Echo Probe back to Client];
    G_2 -- "Data" --> G_5[Add to client's <br> Jitter Buffer];
    G_5 --> G_6[Drain Jitter Buffer in order];
    G_6 --> G_7[Write reordered packet to TUN];

    H --> H_1[Read IP packet from TUN];
    H_1 --> H_2[Find corresponding client];
    H_2 --> H_3[Encrypt packet];
    H_3 --> H_4[Send to client over UDP];
    H_4 --> H_1;

    style E fill:#8f8,stroke:#333,stroke-width:2px
```
